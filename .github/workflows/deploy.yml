name: Build and Release Mod

on:
  push:
    branches:
     - main
     - dev
    tags:
     - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: RageAgainstThePixel/setup-steamcmd@v1

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - run: |
          for i in {1..8}; do
            steamcmd +login anonymous +sDepotDownloadFileFilter "*.dll" +app_update 600760 validate +quit && break
            echo "SteamCMD failed, retry #$i"
            sleep 10
          done
          LATEST_URL=$(curl -s https://api.github.com/repos/StationeersLaunchpad/StationeersLaunchpad/releases/latest | grep "browser_download_url.*StationeersLaunchPad-client" | cut -d : -f 2,3 | tr -d \")
          curl -L $LATEST_URL -o StationeersLaunchpad.zip
          mkdir -p "$STEAM_DIR/steamapps/common/Stationeers Dedicated Server/BepInEx/plugins/"
          unzip -o StationeersLaunchpad.zip -d "$STEAM_DIR/steamapps/common/Stationeers Dedicated Server/BepInEx/plugins/"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build project
        run: |
          export STATIONEERS_DLL_DIR="$STEAM_DIR/steamapps/common/Stationeers Dedicated Server/rocketstation_DedicatedServer_Data/Managed"
          dotnet restore
          dotnet build --configuration Release Main.csproj

      - name: Package DLL and About folder
        if: github.ref_type == 'tag'
        id: package_zip
        run: |
          set -euo pipefail

          # 1) Find the first compiled DLL
          DLL_PATH=$(find ./bin/Release -type f -name '*.dll' | head -n 1)
          echo "Found DLL at: $DLL_PATH"

          # 2) Get base name (without extension) and version from tag
          DLL_FILENAME=$(basename "$DLL_PATH")        # e.g. MyMod.dll
          BASE_NAME="${DLL_FILENAME%.dll}"            # e.g. MyMod
          VERSION="${GITHUB_REF_NAME}"                # e.g. v1.2.3 (tag name)

          # 3) Build zip name: MyMod-v1.2.3.zip
          ZIP_NAME="${BASE_NAME}-${VERSION}.zip"

          # 4) Build package structure
          mkdir -p dist/package
          cp "$DLL_PATH" dist/package/
          cp -r About dist/package/

          # 5) Create zip (DLL + About folder)
          (cd dist/package && zip -r "../$ZIP_NAME" .)

          # 6) Expose zip path as output for later steps (e.g. upload to release)
          echo "zip_path=dist/$ZIP_NAME" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        if: github.ref_type == 'tag'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          files: ${{ steps.find_dll.outputs.zip_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
